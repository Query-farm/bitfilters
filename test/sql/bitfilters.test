# name: test/sql/bitfilters.test
# description: test bitfilters extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require bitfilters

statement ok
create table series_data as (select * as id from generate_series(1, 10000))

statement ok
create table bloom_filters as (
  select id % 2 as remainder, bloomfilter(10000, 0.1, id) as filter
  from series_data
  group by id % 2
);

query II
select remainder,
count(case when bloom_filter_contains(filter, id) then 1 else null end) as is_contained
from series_data,
bloom_filters where series_data.id % 2 == bloom_filters.remainder group by remainder;
----
0	5000
1	5000

query II
select remainder, count(case when bloom_filter_contains(filter, id) then 1 else null end) as false_positives
from series_data, bloom_filters where series_data.id % 2 != bloom_filters.remainder group by remainder;
----
0	46
1	41

statement ok
create table quotient_filters as (
  select id % 2 as remainder, quotient_filter(15, 1, hash(id)) as filter
  from series_data
  group by id % 2
);

query II
select remainder, count(case when quotient_filter_contains(filter, hash(id)) then 1 else null end) as false_positives
from series_data, quotient_filters where series_data.id % 2 != quotient_filters.remainder group by remainder;
----
0	341
1	350

